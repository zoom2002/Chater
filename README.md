# Android èŠå¤©å™¨ (Chater)

è¿™æ˜¯ä¸€ä¸ªåŸºäº Android åŸç”Ÿå¼€å‘çš„ç®€æ˜“å•æœºç‰ˆèŠå¤©åº”ç”¨ï¼Œå®ç°äº†æ¶ˆæ¯åˆ—è¡¨ã€èŠå¤©å¯¹è¯ã€æœªè¯»æ¶ˆæ¯ç®¡ç†ã€æœ¬åœ°æ•°æ®åº“å­˜å‚¨ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ“± åŠŸèƒ½ç‰¹æ€§

1.  **æ¶ˆæ¯åˆ—è¡¨ (MainActivity)**
    *   å±•ç¤ºæ‰€æœ‰å†å²ä¼šè¯ã€‚
    *   **æ™ºèƒ½æ’åº**ï¼šæœªè¯»æ¶ˆæ¯è‡ªåŠ¨ç½®é¡¶ï¼ŒåŒç±»æ¶ˆæ¯æŒ‰æ—¶é—´å€’åºæ’åˆ—ã€‚
    *   **æœªè¯»çº¢ç‚¹**ï¼šå®æ—¶æ˜¾ç¤ºæ¯ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯æ•°é‡ã€‚
    *   **é»˜è®¤æ•°æ®**ï¼šé¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å…¥å¤šç»„æ¼”ç¤ºæ•°æ®ï¼ˆåŒ…å«å·²è¯»/æœªè¯»ã€ä¸åŒæ—¶é—´æ®µçš„æ¶ˆæ¯ï¼‰ã€‚

2.  **èŠå¤©ç•Œé¢ (ChatActivity)**
    *   **æ¶ˆæ¯å±•ç¤º**ï¼šåŒºåˆ†å‘é€è€…ï¼ˆå³ä¾§è“è‰²æ°”æ³¡ï¼‰å’Œæ¥æ”¶è€…ï¼ˆå·¦ä¾§ç°è‰²æ°”æ³¡ï¼‰ã€‚
    *   **è‡ªåŠ¨å›å¤**ï¼šå‘é€æ¶ˆæ¯åï¼Œå¯¹æ–¹ä¼šåœ¨ 1.5 ç§’åè‡ªåŠ¨å›å¤ï¼Œæ¨¡æ‹ŸçœŸå®èŠå¤©ä½“éªŒã€‚
    *   **è¡¨æƒ…æ”¯æŒ**ï¼šå†…ç½® 50+ å¸¸ç”¨ Emoji è¡¨æƒ…é¢æ¿ã€‚
    *   **é”®ç›˜äº¤äº’ä¼˜åŒ–**ï¼š
        *   ç‚¹å‡»ç©ºç™½å¤„è‡ªåŠ¨æ”¶èµ·é”®ç›˜ã€‚
        *   é”®ç›˜å¼¹å‡ºæ—¶ï¼Œæ¶ˆæ¯åˆ—è¡¨è‡ªåŠ¨ä¸Šæ»šåˆ°åº•éƒ¨ï¼Œä¸”è¾“å…¥æ¡†ç´§è´´é”®ç›˜ä¸Šæ–¹ï¼ˆè§£å†³é®æŒ¡é—®é¢˜ï¼‰ã€‚
        *   è¡¨æƒ…é¢æ¿ä¸è½¯é”®ç›˜äº’æ–¥æ˜¾ç¤ºï¼Œåˆ‡æ¢å¹³æ»‘ã€‚

3.  **æ•°æ®å­˜å‚¨**
    *   åŸºäº `SQLite` åŸç”Ÿæ•°æ®åº“ã€‚
    *   æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ï¼Œé‡å¯åº”ç”¨æ•°æ®ä¸ä¸¢å¤±ã€‚

## ğŸ›  ä»£ç ç»“æ„

```
com.example.chater
â”œâ”€â”€ adapter             // é€‚é…å™¨å±‚
â”‚   â”œâ”€â”€ ChatAdapter.java        // èŠå¤©ç•Œé¢æ¶ˆæ¯æ°”æ³¡é€‚é…å™¨
â”‚   â””â”€â”€ ConversationAdapter.java // ä¸»é¡µä¼šè¯åˆ—è¡¨é€‚é…å™¨
â”œâ”€â”€ db                  // æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ ChatDatabaseHelper.java // SQLite æ•°æ®åº“åˆ›å»ºä¸ç‰ˆæœ¬ç®¡ç†
â”‚   â””â”€â”€ MessageDao.java         // æ•°æ®åº“è®¿é—®å¯¹è±¡ï¼Œå°è£…å¢åˆ æ”¹æŸ¥é€»è¾‘
â”œâ”€â”€ model               // å®ä½“å±‚
â”‚   â”œâ”€â”€ Conversation.java       // ä¼šè¯å®ä½“ï¼ˆç”¨äºåˆ—è¡¨å±•ç¤ºï¼‰
â”‚   â””â”€â”€ Message.java            // æ¶ˆæ¯å®ä½“ï¼ˆç”¨äºèŠå¤©è®°å½•ï¼‰
â”œâ”€â”€ ChatActivity.java   // èŠå¤©è¯¦æƒ…é¡µ Activity
â””â”€â”€ MainActivity.java   // åº”ç”¨ä¸»é¡µ Activity
```

## ğŸ’¡ è®¾è®¡æ€è·¯

### 1. ç•Œé¢ UI è®¾è®¡

#### 1.1 æ¶ˆæ¯åˆ—è¡¨é¡µ (`MainActivity`)
*   **å¸ƒå±€ç»“æ„**ï¼š
    *   æ ¹å¸ƒå±€ä½¿ç”¨ `ConstraintLayout`ï¼Œæ–¹ä¾¿æ§åˆ¶ Toolbarã€RecyclerView å’Œæ‚¬æµ®æŒ‰é’®çš„ä½ç½®ã€‚
    *   æ ¸å¿ƒåˆ—è¡¨ä½¿ç”¨ `RecyclerView`ï¼Œé…åˆ `LinearLayoutManager` å®ç°å‚ç›´æ»šåŠ¨åˆ—è¡¨ã€‚
    *   å³ä¸‹è§’æ”¾ç½® `FloatingActionButton` (FAB) ç”¨äºå‘èµ·æ–°èŠå¤©ã€‚
    *   `activity_main.xml`ï¼š
    
    ![image-20251202162304619](E:\byteDanceHomeWork\firstHomeWork_Chater\assets\image-20251202162304619.png)
    
*   **Item è®¾è®¡ (`item_conversation.xml`)**ï¼š
    *   ä½¿ç”¨ `LinearLayout` (æ°´å¹³æ–¹å‘) ä½œä¸ºå®¹å™¨ã€‚
    *   **å¤´åƒ**ï¼š`ImageView`ï¼Œå›ºå®šå¤§å°ã€‚
    *   **ä¸­é—´æ–‡æœ¬åŒº**ï¼š`LinearLayout` (å‚ç›´æ–¹å‘)ï¼ŒåŒ…å«æ˜µç§° (`TextView`, åŠ ç²—) å’Œæœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ (`TextView`, ç°è‰², å•è¡Œæˆªæ–­ `ellipsize="end"`).
    *   **å³ä¾§ä¿¡æ¯åŒº**ï¼š`LinearLayout` (å‚ç›´æ–¹å‘)ï¼ŒåŒ…å«æ—¶é—´æˆ³å’Œ**æœªè¯»çº¢ç‚¹**ã€‚
    *   **çº¢ç‚¹å®ç°**ï¼š`TextView`ï¼ŒèƒŒæ™¯è®¾ç½®ä¸ºåœ†å½¢çº¢è‰² Drawable (`bg_unread_badge.xml`)ï¼Œå½“ `unreadCount > 0` æ—¶æ˜¾ç¤º (`View.VISIBLE`)ï¼Œå¦åˆ™éšè— (`View.GONE`)ã€‚
    *   `item_conversation.xml`ï¼š
    
    ![image-20251202162517918](E:\byteDanceHomeWork\firstHomeWork_Chater\assets\image-20251202162517918.png)

#### 1.2 èŠå¤©å¯¹è¯é¡µ (`ChatActivity`)
*   **å¸ƒå±€ç»“æ„**ï¼š
    
    *   æ ¹å¸ƒå±€ä¸º `LinearLayout` (å‚ç›´æ–¹å‘)ã€‚
    *   é¡¶éƒ¨ï¼š`Toolbar`ã€‚
    *   ä¸­é—´ï¼š`RecyclerView` (`weight=1`)ï¼Œå æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ï¼Œç”¨äºæ˜¾ç¤ºèŠå¤©æ°”æ³¡ã€‚
    *   åº•éƒ¨è¾“å…¥åŒºï¼š`LinearLayout` (æ°´å¹³æ–¹å‘)ï¼ŒåŒ…å«è¡¨æƒ…æŒ‰é’®ã€`EditText` è¾“å…¥æ¡†ã€å‘é€æŒ‰é’®ã€‚
    *   æœ€åº•éƒ¨ï¼š`EmojiPanel` (`LinearLayout`)ï¼Œåˆå§‹çŠ¶æ€ä¸º `GONE`ï¼ŒåŒ…å«ä¸€ä¸ª `GridView` ç”¨äºå±•ç¤ºè¡¨æƒ…ã€‚
    *   `activity_chat.xml`:
    
    ![image-20251202162823923](E:\byteDanceHomeWork\firstHomeWork_Chater\assets\image-20251202162823923.png)
    
*   **å¤šå¸ƒå±€ Item è®¾è®¡**ï¼š
    *   åˆ©ç”¨ `RecyclerView.Adapter` çš„ `getItemViewType` æ–¹æ³•ï¼Œæ ¹æ® `Message.senderId` åˆ¤æ–­æ¶ˆæ¯ç±»å‹ã€‚
    *   **æˆ‘å‘çš„æ¶ˆæ¯**ï¼šåŠ è½½ `item_msg_right.xml`ï¼Œå¸ƒå±€å³å¯¹é½ï¼ŒèƒŒæ™¯ä¸ºè“è‰²åœ†è§’çŸ©å½¢ã€‚
    
    ![image-20251202162928913](E:\byteDanceHomeWork\firstHomeWork_Chater\assets\image-20251202162928913.png)
    
    *   **å¯¹æ–¹å‘çš„æ¶ˆæ¯**ï¼šåŠ è½½ `item_msg_left.xml`ï¼Œå¸ƒå±€å·¦å¯¹é½ï¼ŒèƒŒæ™¯ä¸ºç°è‰²åœ†è§’çŸ©å½¢ã€‚
    
    ![image-20251202162958560](E:\byteDanceHomeWork\firstHomeWork_Chater\assets\image-20251202162958560.png)

### 2. æ•°æ®åº“è®¾è®¡
é‡‡ç”¨ `SQLiteOpenHelper` è¿›è¡Œç®¡ç†ï¼Œè®¾è®¡äº†ä¸¤å¼ è¡¨ä»¥å¹³è¡¡è¯»å†™æ€§èƒ½ã€‚

#### 2.1 `messages` è¡¨ (æ¶ˆæ¯è®°å½•)
å­˜å‚¨æ¯ä¸€æ¡å…·ä½“çš„èŠå¤©å†…å®¹ã€‚
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `id` | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| `content` | TEXT | æ¶ˆæ¯å†…å®¹ |
| `timestamp` | INTEGER | å‘é€æ—¶é—´æˆ³ |
| `sender_id` | INTEGER | å‘é€è€…ID (0è¡¨ç¤ºè‡ªå·±) |
| `chat_id` | INTEGER | æ‰€å±ä¼šè¯ID (å³å¯¹æ–¹ç”¨æˆ·ID) |

#### 2.2 `conversations` è¡¨ (ä¼šè¯å¿«ç…§)
å­˜å‚¨æ¯ä¸ªä¼šè¯çš„æœ€æ–°çŠ¶æ€ï¼Œç”¨äºåˆ—è¡¨é¡µå¿«é€ŸåŠ è½½ï¼Œé¿å…å¯¹ `messages` è¡¨è¿›è¡Œå…¨è¡¨èšåˆæŸ¥è¯¢ã€‚
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `target_user_id` | INTEGER | ä¸»é”®ï¼Œå¯¹æ–¹ç”¨æˆ·ID |
| `target_user_name` | TEXT | å¯¹æ–¹æ˜µç§° |
| `last_message` | TEXT | æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ |
| `last_timestamp` | INTEGER | æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´ |
| `unread_count` | INTEGER | æœªè¯»æ¶ˆæ¯æ•°é‡ |

### 3. æ ¸å¿ƒé€»è¾‘ä¸ç³»ç»Ÿè°ƒç”¨

#### 3.1 æ•°æ®åº“æ“ä½œ (`MessageDao`)
*   **æ’å…¥æ¶ˆæ¯ (`insertMessage`)**ï¼šè¿™æ˜¯ä¸€ä¸ªäº‹åŠ¡æ€§æ“ä½œã€‚
    1.  å‘ `messages` è¡¨æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚
    2.  æŸ¥è¯¢ `conversations` è¡¨æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·çš„ä¼šè¯ã€‚
    3.  å¦‚æœå­˜åœ¨ï¼Œæ›´æ–° `last_message`ã€`last_timestamp`ï¼›å¦‚æœæ˜¯å¯¹æ–¹å‘çš„æ¶ˆæ¯ï¼Œé¢å¤–å°† `unread_count + 1`ã€‚
    4.  å¦‚æœä¸å­˜åœ¨ï¼Œæ’å…¥ä¸€æ¡æ–°ä¼šè¯è®°å½•ï¼Œåˆå§‹åŒ–æœªè¯»æ•°ã€‚
*   **åˆ—è¡¨æŸ¥è¯¢ä¸æ’åº**ï¼š
    ä½¿ç”¨ SQL è¯­å¥ç›´æ¥åœ¨æ•°æ®åº“å±‚é¢å®Œæˆæ’åºï¼Œä¿è¯æ€§èƒ½ï¼š
    
    ```java
    // ä¼˜å…ˆæ˜¾ç¤ºæœ‰æœªè¯»æ¶ˆæ¯çš„ä¼šè¯ï¼Œå…¶æ¬¡æŒ‰æ—¶é—´å€’åº
    String orderBy = "(CASE WHEN unread_count > 0 THEN 1 ELSE 0 END) DESC, last_timestamp DESC";
    db.query(TABLE_CONVERSATIONS, ..., orderBy);
    ```

#### 3.2 é”®ç›˜ä¸å¸ƒå±€äº¤äº’ (`ChatActivity`)
*   **ç›‘å¬å¸ƒå±€å˜åŒ–**ï¼š
    è°ƒç”¨ `rootLayout.getViewTreeObserver().addOnGlobalLayoutListener(...)` ç›‘å¬å…¨å±€å¸ƒå±€æ ‘çš„å˜åŒ–ã€‚
*   **è®¡ç®—é”®ç›˜é«˜åº¦**ï¼š
    ```java
    Rect r = new Rect();
    rootLayout.getWindowVisibleDisplayFrame(r); // è·å–å½“å‰çª—å£å¯è§†åŒºåŸŸ
    int keypadHeight = rootHeight - r.bottom;   // æ€»é«˜åº¦ - å¯è§†åº•éƒ¨ = é”®ç›˜é«˜åº¦
    ```
*   **åŠ¨æ€è°ƒæ•´å¸ƒå±€**ï¼š
    å½“æ£€æµ‹åˆ° `keypadHeight` å¤§äºä¸€å®šé˜ˆå€¼ï¼ˆè¯´æ˜é”®ç›˜å¼¹å‡ºï¼‰æ—¶ï¼Œè°ƒç”¨ `rootLayout.setPadding(0, 0, 0, keypadHeight)`ï¼Œå¼ºåˆ¶ç»™æ ¹å¸ƒå±€åº•éƒ¨å¢åŠ  Paddingï¼Œä»è€Œå°†è¾“å…¥æ¡†é¡¶ä¸Šå»ã€‚
*   **è½¯é”®ç›˜æ§åˆ¶**ï¼š
    ä½¿ç”¨ `InputMethodManager` ç³»ç»ŸæœåŠ¡ï¼š
    *   `imm.showSoftInput(...)`: ä¸»åŠ¨å¼¹å‡ºé”®ç›˜ã€‚
    *   `imm.hideSoftInputFromWindow(...)`: ä¸»åŠ¨æ”¶èµ·é”®ç›˜ã€‚

#### 3.3 å¼‚æ­¥å¤„ç†
*   **æ¨¡æ‹Ÿè‡ªåŠ¨å›å¤**ï¼š
    ä½¿ç”¨ `Handler(Looper.getMainLooper()).postDelayed(...)` å®ç° 1.5 ç§’åçš„å»¶è¿Ÿå›å¤ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ UIã€‚

## ğŸš€ è¿è¡Œè¯´æ˜
1.  ä½¿ç”¨ Android Studio æ‰“å¼€é¡¹ç›®ã€‚
2.  åŒæ­¥ Gradle æ„å»ºã€‚
3.  è¿æ¥æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºï¼ˆAPI 24+ï¼‰ã€‚
4.  ç›´æ¥è¿è¡Œå³å¯ã€‚
